package testcases;

import factoryRequest.FactoryRequest;
import factoryRequest.Request;
import factoryRequest.RequestInformation;
import factoryRequest.ResponseInformation;
import io.qameta.allure.*;
import io.qameta.allure.junit4.DisplayName;
import org.json.JSONObject;
import org.junit.After;
import org.junit.Test;
import org.junit.runner.RunWith;
import utils.ConfigOwaspAPI;

public class VulnerabilityTest {


    private String idScanner;
    @DisplayName("Romel Silvera - Ejecucion de pruebas de vulnerabilidad Owasp-Zap")
    @Description("Pruebas de vulnerabilidad a la URL: https://todoist.com/")
    @Issue("Bug002")
    @Severity(SeverityLevel.CRITICAL)
    @Test
    public void startVulnerabilityScanner(){
           this.startScanner();
           this.monitoring();
    }

    @After
    public void after(){
        RequestInformation information = new RequestInformation();
        information.setUrl(ConfigOwaspAPI.GET_REPORT);
        ResponseInformation responseInformation=FactoryRequest.make("get").send(information);
        this.attachmentFile("OWASP ZAP REPORT",responseInformation.getBody());
        information.setUrl(ConfigOwaspAPI.GET_ATACK+idScanner);
        responseInformation=FactoryRequest.make("get").send(information);
        this.attachmentFile("Lista De Vulnerabilidades",responseInformation.getBody());
    }

    @Attachment(value="{0}", type="text/html")
    public String attachmentFile(String name,String content){
        return content;
    }


    @Step("Iniciando el scaneo de vulnerabilidades con OWASP-ZAP")
    public void startScanner(){
        RequestInformation information = new RequestInformation();
        information.setUrl(ConfigOwaspAPI.START_SCANNER+"https://todoist.com/");
        ResponseInformation responseInformation=FactoryRequest.make("get").send(information);
        JSONObject body = new JSONObject(responseInformation.getBody());
        idScanner=body.get("scan").toString();
        System.out.println("********** ID "+idScanner);
    }

    @Step("Monitoreando el progreso 100%")
    public void monitoring(){
        String percentage="0";
        RequestInformation information = new RequestInformation();
        information.setUrl(ConfigOwaspAPI.GET_PROGRESS+idScanner);
        while(!percentage.equals("100")){
            try {
                Thread.sleep(50000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            ResponseInformation responseInformation=FactoryRequest.make("get").send(information);
            JSONObject body = new JSONObject(responseInformation.getBody());
            percentage=body.get("status").toString();
            System.out.println("STATUS ----> "+percentage);
        }
    }
}
